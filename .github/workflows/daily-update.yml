name: Daily Clash Butler Update

on:
  schedule: 
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸‹åˆ 23:00 (UTC 15:00)
    - cron: '0 15 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  CARGO_TERM_COLOR: always

jobs:
  update-clash-config:
    name: Update Clash Configuration
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip
          
      - name: Download Clash Meta
        run: |
          mkdir -p clash-meta
          wget -O clash-meta.tar.gz "https://github.com/MetaCubeX/mihomo/releases/latest/download/mihomo-linux-amd64-compatible-v1.18.10.tar.gz"
          tar -xzf clash-meta.tar.gz -C clash-meta --strip-components=1
          chmod +x clash-meta/mihomo
          
      - name: Build project
        run: cargo build --release
        
      - name: Run Clash Butler
        id: run_butler
        run: |
          echo "å¼€å§‹è¿è¡Œ Clash Butler..."
          
          # è®¾ç½®å¼€å§‹æ—¶é—´
          START_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT
          
          # è¿è¡Œç¨‹åºå¹¶æ•è·è¾“å‡º
          if timeout 1800 cargo run --release > run_output.log 2>&1; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "Clash Butler è¿è¡ŒæˆåŠŸ"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "Clash Butler è¿è¡Œå¤±è´¥"
          fi
          
          # è®¾ç½®ç»“æŸæ—¶é—´
          END_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          echo "end_time=$END_TIME" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
          if [ -f "clash.yaml" ]; then
            PROXY_COUNT=$(grep -c "^  - name:" clash.yaml || echo "0")
            echo "proxy_count=$PROXY_COUNT" >> $GITHUB_OUTPUT
            echo "ç”Ÿæˆçš„ä»£ç†èŠ‚ç‚¹æ•°é‡: $PROXY_COUNT"
          else
            echo "proxy_count=0" >> $GITHUB_OUTPUT
            echo "æœªæ‰¾åˆ°ç”Ÿæˆçš„ clash.yaml æ–‡ä»¶"
          fi
          
      - name: Upload run logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: clash-butler-logs
          path: |
            run_output.log
            logs/
          retention-days: 7
          
      - name: Commit and push changes
        if: steps.run_butler.outputs.status == 'success'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ¤– è‡ªåŠ¨æ›´æ–° Clash é…ç½® - ${{ steps.run_butler.outputs.proxy_count }} ä¸ªå¯ç”¨èŠ‚ç‚¹"
          file_pattern: "clash.yaml"
          
      - name: Send success email notification
        if: steps.run_butler.outputs.status == 'success'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "âœ… Clash Butler æ¯æ—¥æ›´æ–°æˆåŠŸ"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_FROM }}
          html_body: |
            <h2>ğŸ‰ Clash Butler æ¯æ—¥æ›´æ–°æˆåŠŸ</h2>
            <p><strong>æ‰§è¡Œæ—¶é—´:</strong> ${{ steps.run_butler.outputs.start_time }} - ${{ steps.run_butler.outputs.end_time }}</p>
            <p><strong>å¯ç”¨èŠ‚ç‚¹æ•°é‡:</strong> ${{ steps.run_butler.outputs.proxy_count }} ä¸ª</p>
            <p><strong>ä»“åº“åœ°å€:</strong> <a href="${{ github.server_url }}/${{ github.repository }}">${{ github.repository }}</a></p>
            <p><strong>æœ€æ–°é…ç½®æ–‡ä»¶:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/blob/master/clash.yaml">clash.yaml</a></p>
            <hr>
            <p><em>æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€</em></p>
            
      - name: Send failure email notification
        if: steps.run_butler.outputs.status == 'failed'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "âŒ Clash Butler æ¯æ—¥æ›´æ–°å¤±è´¥"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_FROM }}
          html_body: |
            <h2>âš ï¸ Clash Butler æ¯æ—¥æ›´æ–°å¤±è´¥</h2>
            <p><strong>æ‰§è¡Œæ—¶é—´:</strong> ${{ steps.run_butler.outputs.start_time }} - ${{ steps.run_butler.outputs.end_time }}</p>
            <p><strong>å¤±è´¥åŸå› :</strong> ç¨‹åºæ‰§è¡Œè¶…æ—¶æˆ–å‡ºç°é”™è¯¯</p>
            <p><strong>ä»“åº“åœ°å€:</strong> <a href="${{ github.server_url }}/${{ github.repository }}">${{ github.repository }}</a></p>
            <p><strong>æŸ¥çœ‹æ—¥å¿—:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/actions">GitHub Actions</a></p>
            <hr>
            <p><em>è¯·æ£€æŸ¥é…ç½®æ–‡ä»¶å’Œè®¢é˜…é“¾æ¥æ˜¯å¦æ­£å¸¸</em></p>
            <p><em>æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€</em></p>