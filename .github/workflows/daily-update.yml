name: Daily Clash Butler Update

on:
  schedule: 
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸‹åˆ 23:00 (UTC 15:00)
    - cron: '0 15 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  CARGO_TERM_COLOR: always

jobs:
  update-clash-config:
    name: Update Clash Configuration
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        
      - name: Setup Clash Meta for Linux
        run: |
          echo "ä¸º Linux ç¯å¢ƒå‡†å¤‡ Clash Meta..."
          
          # æ£€æŸ¥ç°æœ‰æ–‡ä»¶æ˜¯å¦ä¸º Linux ç‰ˆæœ¬
          if [ -f "clash-meta/mihomo" ]; then
            echo "å‘ç°ç°æœ‰çš„ mihomo æ–‡ä»¶ï¼Œæ£€æŸ¥æ˜¯å¦é€‚ç”¨äº Linux..."
            chmod +x clash-meta/mihomo
            
            # å°è¯•è¿è¡Œï¼Œå¦‚æœå¤±è´¥åˆ™ä¸‹è½½ Linux ç‰ˆæœ¬
            if ./clash-meta/mihomo -v >/dev/null 2>&1; then
              echo "âœ… ç°æœ‰æ–‡ä»¶å¯åœ¨ Linux ä¸Šè¿è¡Œ"
            else
              echo "âš ï¸ ç°æœ‰æ–‡ä»¶ä¸é€‚ç”¨äº Linuxï¼Œä¸‹è½½ Linux ç‰ˆæœ¬..."
              
              # è·å–æœ€æ–°ç‰ˆæœ¬å·
              LATEST_VERSION=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
              
              if [ -z "$LATEST_VERSION" ]; then
                echo "æ— æ³•è·å–æœ€æ–°ç‰ˆæœ¬ï¼Œä½¿ç”¨å¤‡ç”¨ç‰ˆæœ¬ v1.19.11"
                LATEST_VERSION="v1.19.11"
              fi
              
              echo "ä¸‹è½½ç‰ˆæœ¬: $LATEST_VERSION"
              
              # ä¸‹è½½ Linux ç‰ˆæœ¬
              DOWNLOAD_URL="https://github.com/MetaCubeX/mihomo/releases/download/${LATEST_VERSION}/mihomo-linux-amd64-${LATEST_VERSION}.gz"
              echo "ä¸‹è½½åœ°å€: $DOWNLOAD_URL"
              
              if wget -O mihomo-linux.gz "$DOWNLOAD_URL"; then
                echo "ä¸‹è½½æˆåŠŸï¼Œè§£å‹ä¸­..."
                gunzip mihomo-linux.gz
                mv mihomo-linux clash-meta/mihomo
                chmod +x clash-meta/mihomo
              else
                echo "ä¸‹è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨ä¸‹è½½æ–¹å¼..."
                BACKUP_URL="https://github.com/MetaCubeX/mihomo/releases/download/${LATEST_VERSION}/mihomo-linux-amd64.gz"
                echo "å¤‡ç”¨ä¸‹è½½åœ°å€: $BACKUP_URL"
                
                if wget -O mihomo-linux.gz "$BACKUP_URL"; then
                  gunzip mihomo-linux.gz
                  mv mihomo-linux clash-meta/mihomo
                  chmod +x clash-meta/mihomo
                else
                  echo "âŒ æ— æ³•ä¸‹è½½ Linux ç‰ˆæœ¬çš„ mihomo"
                  exit 1
                fi
              fi
            fi
          else
            echo "âŒ æœªæ‰¾åˆ° mihomo æ–‡ä»¶"
            exit 1
          fi
          
          # éªŒè¯æœ€ç»ˆæ–‡ä»¶
          echo "éªŒè¯ Clash Meta:"
          echo "æ–‡ä»¶å¤§å°: $(du -h clash-meta/mihomo | cut -f1)"
          echo "æ–‡ä»¶æƒé™: $(ls -l clash-meta/mihomo)"
          
          # è·å–ç‰ˆæœ¬ä¿¡æ¯
          echo "Clash Meta ç‰ˆæœ¬ä¿¡æ¯:"
          ./clash-meta/mihomo -v || echo "æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯ï¼Œä½†æ–‡ä»¶å­˜åœ¨"
          
          echo "âœ… Clash Meta å‡†å¤‡å°±ç»ª"
          
      - name: Build project
        run: cargo build --release
        
      - name: Run Clash Butler
        id: run_butler
        run: |
          echo "å¼€å§‹è¿è¡Œ Clash Butler..."
          
          # è®¾ç½®å¼€å§‹æ—¶é—´
          START_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT
          
          # è¿è¡Œç¨‹åºå¹¶æ•è·è¾“å‡º
          echo "æ­£åœ¨æ‰§è¡Œ Clash Butlerï¼Œæœ€å¤§ç­‰å¾…æ—¶é—´ 180 åˆ†é’Ÿï¼ˆ3å°æ—¶ï¼‰..."
          echo "æ³¨æ„ï¼šç¨‹åºä¼šå®æ—¶æ˜¾ç¤ºè¾“å‡ºï¼ŒåŒæ—¶ä¿å­˜åˆ°æ—¥å¿—æ–‡ä»¶"
          
          # ä½¿ç”¨ tee å‘½ä»¤åŒæ—¶æ˜¾ç¤ºè¾“å‡ºå’Œä¿å­˜åˆ°æ–‡ä»¶
          if timeout 10800 cargo run --release 2>&1 | tee run_output.log; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… Clash Butler è¿è¡ŒæˆåŠŸ"
          else
            EXIT_CODE=${PIPESTATUS[0]}  # è·å– timeout å‘½ä»¤çš„é€€å‡ºç 
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ Clash Butler è¿è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $EXIT_CODE"
            
            # æ•è·é”™è¯¯ä¿¡æ¯
            if [ $EXIT_CODE -eq 124 ]; then
              ERROR_MSG="ç¨‹åºæ‰§è¡Œè¶…æ—¶ï¼ˆè¶…è¿‡180åˆ†é’Ÿï¼‰"
            else
              ERROR_MSG="ç¨‹åºå¼‚å¸¸é€€å‡ºï¼Œé€€å‡ºç : $EXIT_CODE"
            fi
            echo "error_message=$ERROR_MSG" >> $GITHUB_OUTPUT
            
            # æ˜¾ç¤ºé”™è¯¯æ—¥å¿—çš„æœ€åéƒ¨åˆ†
            echo "ç¨‹åºè¾“å‡ºçš„æœ€å 30 è¡Œ:"
            tail -n 30 run_output.log || echo "æ— æ³•è¯»å–è¾“å‡ºæ—¥å¿—"
          fi
          
          # è®¾ç½®ç»“æŸæ—¶é—´
          END_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          echo "end_time=$END_TIME" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
          TOTAL_PROXY_COUNT=0
          
          # æ£€æŸ¥å¿«é€Ÿæ¨¡å¼é…ç½®æ–‡ä»¶
          if [ -f "clash-fast.yaml" ]; then
            # ç»Ÿè®¡ proxies éƒ¨åˆ†çš„èŠ‚ç‚¹æ•°é‡ï¼Œæ’é™¤ proxy-groups éƒ¨åˆ†
            FAST_PROXY_COUNT=$(awk '/^proxies:/{p=1;next} p && /^[a-z]/{p=0} p && /^  - name:/{c++} END{print c+0}' clash-fast.yaml 2>/dev/null || echo "0")
            echo "fast_proxy_count=$FAST_PROXY_COUNT" >> $GITHUB_OUTPUT
            echo "å¿«é€Ÿæ¨¡å¼ä»£ç†èŠ‚ç‚¹æ•°é‡: $FAST_PROXY_COUNT"
            
            FAST_FILE_SIZE=$(du -h clash-fast.yaml 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
            echo "å¿«é€Ÿæ¨¡å¼é…ç½®æ–‡ä»¶å¤§å°: $FAST_FILE_SIZE"
            echo "fast_file_size=$FAST_FILE_SIZE" >> $GITHUB_OUTPUT
            
            TOTAL_PROXY_COUNT=$((TOTAL_PROXY_COUNT + FAST_PROXY_COUNT))
          else
            echo "fast_proxy_count=0" >> $GITHUB_OUTPUT
            echo "fast_file_size=æœªç”Ÿæˆ" >> $GITHUB_OUTPUT
            echo "æœªæ‰¾åˆ°ç”Ÿæˆçš„ clash-fast.yaml æ–‡ä»¶"
          fi
          
          # æ£€æŸ¥å®Œæ•´å¤„ç†é…ç½®æ–‡ä»¶
          if [ -f "clash.yaml" ]; then
            # ç»Ÿè®¡ proxies éƒ¨åˆ†çš„èŠ‚ç‚¹æ•°é‡ï¼Œæ’é™¤ proxy-groups éƒ¨åˆ†
            FULL_PROXY_COUNT=$(awk '/^proxies:/{p=1;next} p && /^[a-z]/{p=0} p && /^  - name:/{c++} END{print c+0}' clash.yaml 2>/dev/null || echo "0")
            echo "full_proxy_count=$FULL_PROXY_COUNT" >> $GITHUB_OUTPUT
            echo "å®Œæ•´å¤„ç†ä»£ç†èŠ‚ç‚¹æ•°é‡: $FULL_PROXY_COUNT"
            
            FULL_FILE_SIZE=$(du -h clash.yaml 2>/dev/null | cut -f1 || echo "æœªçŸ¥")
            echo "å®Œæ•´å¤„ç†é…ç½®æ–‡ä»¶å¤§å°: $FULL_FILE_SIZE"
            echo "full_file_size=$FULL_FILE_SIZE" >> $GITHUB_OUTPUT
            
            # æ˜¾ç¤ºæ–‡ä»¶çš„å‰å‡ è¡Œä»¥éªŒè¯æ ¼å¼
            echo "å®Œæ•´å¤„ç†é…ç½®æ–‡ä»¶å‰ 5 è¡Œ:"
            head -n 5 clash.yaml || echo "æ— æ³•è¯»å–æ–‡ä»¶å†…å®¹"
            
            TOTAL_PROXY_COUNT=$((TOTAL_PROXY_COUNT + FULL_PROXY_COUNT))
          else
            echo "full_proxy_count=0" >> $GITHUB_OUTPUT
            echo "full_file_size=æœªç”Ÿæˆ" >> $GITHUB_OUTPUT
            echo "æœªæ‰¾åˆ°ç”Ÿæˆçš„ clash.yaml æ–‡ä»¶"
          fi
          
          # è®¾ç½®æ€»èŠ‚ç‚¹æ•°é‡
          echo "proxy_count=$TOTAL_PROXY_COUNT" >> $GITHUB_OUTPUT
          echo "æ€»ä»£ç†èŠ‚ç‚¹æ•°é‡: $TOTAL_PROXY_COUNT"
          
      - name: Upload run logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: clash-butler-logs
          path: |
            run_output.log
            logs/
          retention-days: 7
          
      - name: Commit and push changes
        if: steps.run_butler.outputs.status == 'success'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ¤– è‡ªåŠ¨æ›´æ–° Clash é…ç½® - å¿«é€Ÿæ¨¡å¼: ${{ steps.run_butler.outputs.fast_proxy_count }} ä¸ªèŠ‚ç‚¹, å®Œæ•´å¤„ç†: ${{ steps.run_butler.outputs.full_proxy_count }} ä¸ªèŠ‚ç‚¹"
          file_pattern: "clash.yaml clash-fast.yaml"
          
      - name: Send success email notification
        if: steps.run_butler.outputs.status == 'success'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "âœ… Clash Butler æ¯æ—¥æ›´æ–°æˆåŠŸ - å¿«é€Ÿæ¨¡å¼: ${{ steps.run_butler.outputs.fast_proxy_count }} ä¸ªèŠ‚ç‚¹, å®Œæ•´å¤„ç†: ${{ steps.run_butler.outputs.full_proxy_count }} ä¸ªèŠ‚ç‚¹"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_FROM }}
          html_body: |
            <h2>ğŸ‰ Clash Butler æ¯æ—¥æ›´æ–°æˆåŠŸ</h2>
            
            <h3>ğŸ“Š æ›´æ–°ç»Ÿè®¡</h3>
            <ul>
              <li><strong>æ‰§è¡Œæ—¶é—´:</strong> ${{ steps.run_butler.outputs.start_time }} - ${{ steps.run_butler.outputs.end_time }}</li>
              <li><strong>å¿«é€Ÿæ¨¡å¼èŠ‚ç‚¹æ•°é‡:</strong> ${{ steps.run_butler.outputs.fast_proxy_count }} ä¸ª</li>
              <li><strong>å¿«é€Ÿæ¨¡å¼æ–‡ä»¶å¤§å°:</strong> ${{ steps.run_butler.outputs.fast_file_size }}</li>
              <li><strong>å®Œæ•´å¤„ç†èŠ‚ç‚¹æ•°é‡:</strong> ${{ steps.run_butler.outputs.full_proxy_count }} ä¸ª</li>
              <li><strong>å®Œæ•´å¤„ç†æ–‡ä»¶å¤§å°:</strong> ${{ steps.run_butler.outputs.full_file_size }}</li>
              <li><strong>æ€»èŠ‚ç‚¹æ•°é‡:</strong> ${{ steps.run_butler.outputs.proxy_count }} ä¸ª</li>
              <li><strong>æ‰§è¡ŒçŠ¶æ€:</strong> âœ… æˆåŠŸ</li>
            </ul>
            
            <h3>ğŸ”— ç›¸å…³é“¾æ¥</h3>
            <ul>
              <li><strong>ä»“åº“åœ°å€:</strong> <a href="${{ github.server_url }}/${{ github.repository }}">${{ github.repository }}</a></li>
              <li><strong>å¿«é€Ÿæ¨¡å¼é…ç½®æ–‡ä»¶:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/blob/master/clash-fast.yaml">clash-fast.yaml</a></li>
              <li><strong>å®Œæ•´å¤„ç†é…ç½®æ–‡ä»¶:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/blob/master/clash.yaml">clash.yaml</a></li>
              <li><strong>æ‰§è¡Œæ—¥å¿—:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">æŸ¥çœ‹è¯¦ç»†æ—¥å¿—</a></li>
            </ul>
            
            <h3>ğŸ“ ä½¿ç”¨è¯´æ˜</h3>
            <p>æ‚¨å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©ä»¥ä¸‹ä»»ä¸€é“¾æ¥ä½œä¸º Clash è®¢é˜…åœ°å€ï¼š</p>
            <ul>
              <li><strong>å¿«é€Ÿæ¨¡å¼ï¼ˆåŒ…å«æ›´å¤šèŠ‚ç‚¹ï¼Œå¦‚é¦™æ¸¯èŠ‚ç‚¹ï¼‰:</strong><br>
                  <code>${{ github.server_url }}/${{ github.repository }}/raw/master/clash-fast.yaml</code></li>
              <li><strong>å®Œæ•´å¤„ç†ï¼ˆç»è¿‡ OpenAI/Claude æµ‹è¯•å’Œé‡å‘½åï¼‰:</strong><br>
                  <code>${{ github.server_url }}/${{ github.repository }}/raw/master/clash.yaml</code></li>
            </ul>
            
            <hr>
            <p><em>æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€ | æ‰§è¡ŒID: ${{ github.run_id }}</em></p>
            
      - name: Send failure email notification
        if: steps.run_butler.outputs.status == 'failed'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "âŒ Clash Butler æ¯æ—¥æ›´æ–°å¤±è´¥"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_FROM }}
          html_body: |
            <h2>âš ï¸ Clash Butler æ¯æ—¥æ›´æ–°å¤±è´¥</h2>
            
            <h3>ğŸ“Š æ‰§è¡Œä¿¡æ¯</h3>
            <ul>
              <li><strong>æ‰§è¡Œæ—¶é—´:</strong> ${{ steps.run_butler.outputs.start_time }} - ${{ steps.run_butler.outputs.end_time }}</li>
              <li><strong>å¤±è´¥åŸå› :</strong> ${{ steps.run_butler.outputs.error_message || 'ç¨‹åºæ‰§è¡Œå¼‚å¸¸' }}</li>
              <li><strong>æ‰§è¡ŒçŠ¶æ€:</strong> âŒ å¤±è´¥</li>
              <li><strong>è¶…æ—¶è®¾ç½®:</strong> 180 åˆ†é’Ÿï¼ˆ3å°æ—¶ï¼‰</li>
            </ul>
            
            <h3>ğŸ”— æ’æŸ¥é“¾æ¥</h3>
            <ul>
              <li><strong>ä»“åº“åœ°å€:</strong> <a href="${{ github.server_url }}/${{ github.repository }}">${{ github.repository }}</a></li>
              <li><strong>æŸ¥çœ‹è¯¦ç»†æ—¥å¿—:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">GitHub Actions æ—¥å¿—</a></li>
              <li><strong>ä¸‹è½½æ—¥å¿—æ–‡ä»¶:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">clash-butler-logs</a></li>
            </ul>
            
            <h3>ğŸ› ï¸ å¸¸è§é—®é¢˜æ’æŸ¥</h3>
            <ol>
              <li>æ£€æŸ¥ <code>conf/config.toml</code> ä¸­çš„è®¢é˜…é“¾æ¥æ˜¯å¦æœ‰æ•ˆ</li>
              <li>ç¡®è®¤è®¢é˜…æºæ˜¯å¦æ­£å¸¸å“åº”</li>
              <li>æŸ¥çœ‹æ˜¯å¦æœ‰ç½‘ç»œè¿æ¥é—®é¢˜</li>
              <li>æ£€æŸ¥ Clash Meta ä¸‹è½½æ˜¯å¦æˆåŠŸ</li>
            </ol>
            
            <hr>
            <p><em>å»ºè®®æ£€æŸ¥é…ç½®æ–‡ä»¶å’Œè®¢é˜…é“¾æ¥ï¼Œç„¶åæ‰‹åŠ¨é‡æ–°è¿è¡Œä»»åŠ¡</em></p>
            <p><em>æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€ | æ‰§è¡ŒID: ${{ github.run_id }}</em></p>