# Clash-Butler 架构摘要

**1. 项目高层目标**

Clash-Butler 是一个围绕 `clash-meta` 核心构建的代理配置自动化工具。其主要目标是聚合来自多个来源（订阅链接、本地文件）的代理服务器节点，通过一系列自动化测试（连通性、流媒体解锁、带宽速度）来筛选出高质量、可用的节点，并最终生成一个优化过的、可直接供 Clash 客户端使用的配置文件。

**2. 主要 Crate 及其职责**

项目由一个主应用和两个核心库 (crate) 组成，形成了一个清晰的模块化结构：

*   **`clash-butler` (主应用):**
    *   **职责:** 作为应用的入口点和流程协调器。它提供了两种运行模式：
        1.  **CLI 工具:** 执行一次性的订阅获取、节点测试、筛选和配置文件生成任务。
        2.  **Web 服务器:** 通过 `axum` 框架提供一个 HTTP API，允许远程触发和管理上述流程，并提供生成的配置文件下载。
    *   **交互:** 它依赖 `proxrs` 来处理所有与订阅相关的数据，并调用 `clash-meta` 二进制文件作为测试后端。

*   **`proxrs` (核心逻辑库):**
    *   **职责:** 封装了所有与代理订阅解析和处理相关的核心业务逻辑。这是项目中最关键的模块之一。
    *   **功能:**
        *   从 URL 或本地文件获取订阅内容。
        *   智能检测并解析多种订阅格式（Clash YAML, Base64, 纯链接）。
        *   将不同格式的代理信息统一抽象为内部的 `Proxy` 数据结构。
        *   提供节点去重、重命名等工具函数。
        *   将处理后的节点列表与 Clash 模板文件合并，生成最终配置文件。

*   **`proxrs-wasm` (WASM 封装库):**
    *   **职责:** 将 `proxrs` 库的功能编译为 WebAssembly。
    *   **当前状态:** 处于早期开发阶段，尚未完全实现功能。
    *   **未来目标:** 旨在将核心的订阅解析能力带到浏览器端，可能用于构建一个纯前端的代理配置处理工具。

**3. 关键模块及其交互**

*   **`main.rs` (流程控制器):** 读取 `settings.rs` 的配置，调用 `proxrs` 获取初始节点列表，然后启动 `clash.rs` 封装的 `clash-meta` 实例。
*   **`clash.rs` (Clash 交互层):** 作为一个适配器，负责启动/停止 `clash-meta` 进程，并通过其 API 执行节点延迟测试和代理切换。它是所有自动化测试的基础。
*   **`sub.rs` (in `proxrs`):** 订阅处理核心，负责获取、解析和格式化代理节点。
*   **`speedtest.rs` (测速模块):** 在 `main.rs` 的流程中被调用，用于对通过连通性测试的节点进行带宽测速。
*   **`server.rs` & `routes/*` (Web 服务层):** 当以 `--server` 模式运行时，此模块接管控制权，提供 API 端点来暴露 `clash-butler` 的核心功能。

**交互流程 (CLI 模式):**
`main.rs` -> `proxrs::sub::get_proxies_from_urls` (获取节点) -> `clash.rs::start` (启动Clash) -> `clash.rs::test_group` (测试连通性) -> `speedtest.rs::test_proxy_speed` (测速) -> `proxrs::sub::save_proxies_into_clash_file` (生成最终配置) -> `clash.rs::stop` (停止Clash)。

**4. 配置与规则的作用**

*   **`conf/` 目录:**
    *   `config.toml`: 定义了整个应用的行为，如订阅链接、是否启用测速、节点重命名规则等。
    *   `clash_*.yaml`: 作为模板文件。`proxrs` 会读取这些模板，并将最终筛选出的节点填充进去，而不是从零开始创建配置文件。这使得用户可以轻松自定义 Clash 的规则和其他高级设置。
*   **`rules/` 目录:**
    *   存放 Clash 的分流规则文件（`.list`, `.mrs`）。这些规则被 `conf/clash_*.yaml` 模板引用，用于实现基于域名或 IP 的智能流量路由。